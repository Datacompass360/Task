<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add a simple favicon to prevent 404 errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœ…</text></svg>">
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* Drag and drop styles */
        .kanban-column { min-height: 200px; }
        .task-card.dragging { opacity: 0.5; transform: rotate(2deg); }
        
        /* Modal transition */
        #item-modal, #modal-overlay {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans antialiased">

    <!-- Main container -->
    <div id="app-container" class="flex h-screen overflow-hidden">

        <!-- Login Page -->
        <div id="login-page" class="w-full h-full flex items-center justify-center bg-gray-200 dark:bg-gray-800">
            <div class="w-full max-w-md p-8 space-y-8 bg-white dark:bg-gray-900 rounded-2xl shadow-lg">
                <div class="text-center">
                    <h2 class="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white">
                        Sign in to your account
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:bg-gray-700 dark:text-white rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:bg-gray-700 dark:text-white rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mt-2"></p>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Sign in
                        </button>
                    </div>
                </form>
                 <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                    Or
                    <a href="#" id="signup-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        create an account
                    </a>
                </p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden flex w-full">
            <!-- Sidebar -->
            <aside class="w-64 bg-white dark:bg-gray-800 p-4 flex flex-col shadow-lg">
                <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-8">Dashboard</div>
                <nav class="flex flex-col space-y-2">
                    <a href="#" data-section="overview" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700">Overview</a>
                    <a href="#" data-section="shortcuts" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Shortcuts</a>
                    <a href="#" data-section="tasks" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Tasks</a>
                    <a href="#" data-section="notes" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Notes</a>
                    <a href="#" data-section="reminders" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Reminders</a>
                    <a href="#" data-section="profile" class="nav-link flex items-center p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Profile</a>
                </nav>
                <div class="mt-auto">
                    <div id="user-profile" class="flex items-center space-x-3 p-2 rounded-lg">
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-bold" id="user-initial"></div>
                        <div>
                            <p class="font-semibold text-sm" id="user-name">User Name</p>
                            <p class="text-xs text-gray-500" id="user-email">user@example.com</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="w-full mt-4 text-left p-2 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-800">Logout</button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <header class="flex justify-between items-center mb-6">
                     <div class="relative w-full max-w-md">
                        <input type="text" id="global-search" placeholder="Search anything..." class="w-full p-2 pl-10 rounded-lg border bg-gray-200 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <!-- Sun/Moon icon here -->
                        </button>
                    </div>
                </header>

                <!-- Dynamic Content Sections -->
                <div id="content-sections">
                    <!-- Overview Section -->
                    <div id="overview-section" class="content-section"></div>
                    <!-- Shortcuts Section -->
                    <div id="shortcuts-section" class="content-section hidden"></div>
                    <!-- Tasks Section -->
                    <div id="tasks-section" class="content-section hidden"></div>
                    <!-- Notes Section -->
                    <div id="notes-section" class="content-section hidden"></div>
                    <!-- Reminders Section -->
                    <div id="reminders-section" class="content-section hidden"></div>
                    <!-- Profile Section -->
                    <div id="profile-section" class="content-section hidden"></div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Reusable Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>
    <div id="item-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md hidden z-50 transform scale-95">
        <div class="flex justify-between items-center border-b pb-3 dark:border-gray-600">
            <h3 id="modal-title" class="text-xl font-semibold">Add Item</h3>
            <button id="modal-close-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="modal-body" class="mt-4">
            <!-- Dynamic form content will be injected here -->
        </div>
        <div id="modal-footer" class="mt-6 flex justify-end space-x-3 border-t pt-4 dark:border-gray-600">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
            <button id="modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold">Confirm Deletion</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6W3bpYgKinmHbs-hgf2F_W3BQSwxfAwk",
            authDomain: "customer-experience-controls-2.firebaseapp.com",
            projectId: "customer-experience-controls-2",
            storageBucket: "customer-experience-controls-2.appspot.com",
            messagingSenderId: "144837337826",
            appId: "1:144837337826:web:63c952a42599279d4534bb",
            measurementId: "G-V4PF0XBT2J"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');
        
        // App state
        let currentUserId = null;
        let unsubscribeShortcuts, unsubscribeTasks, unsubscribeNotes, unsubscribeReminders;
        let allShortcuts = [], allTasks = [], allNotes = [], allReminders = [];

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const signupLink = document.getElementById('signup-link');
        const loginError = document.getElementById('login-error');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loginPage.style.display = 'none';
                dashboard.style.display = 'flex';
                updateUserInfo(user);
                fetchAllData();
            } else {
                currentUserId = null;
                loginPage.style.display = 'flex';
                dashboard.style.display = 'none';
                if (unsubscribeShortcuts) unsubscribeShortcuts();
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeNotes) unsubscribeNotes();
                if (unsubscribeReminders) unsubscribeReminders();
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            const isSigningUp = signupLink.textContent.trim().toLowerCase().includes('sign in');

            loginError.textContent = '';

            if (isSigningUp) {
                createUserWithEmailAndPassword(auth, email, password)
                    .then(userCredential => {
                        updateProfile(userCredential.user, { displayName: email.split('@')[0] });
                    })
                    .catch(error => {
                        loginError.textContent = error.message;
                    });
            } else {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        loginError.textContent = error.message;
                    });
            }
        });

        signupLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isSigningUp = signupLink.textContent.trim().toLowerCase().includes('sign in');
            if (isSigningUp) {
                loginForm.querySelector('button[type="submit"]').textContent = 'Sign in';
                signupLink.innerHTML = `create an account`;
                 document.querySelector('#login-page h2').textContent = 'Sign in to your account';
            } else {
                loginForm.querySelector('button[type="submit"]').textContent = 'Sign up';
                signupLink.innerHTML = `Sign in instead`;
                 document.querySelector('#login-page h2').textContent = 'Create a new account';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        function updateUserInfo(user) {
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            const userInitialEl = document.getElementById('user-initial');
            
            if(user) {
                const displayName = user.displayName || user.email;
                userNameEl.textContent = displayName;
                userEmailEl.textContent = user.email;
                userInitialEl.textContent = (displayName?.[0] || 'U').toUpperCase();
            }
        }

        // --- NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.dataset.section;

                navLinks.forEach(l => {
                    l.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                });
                link.classList.add('bg-gray-200', 'dark:bg-gray-700');

                contentSections.forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            });
        });

        // --- DATA FETCHING & RENDERING ---
        function fetchAllData() {
            if (!currentUserId) return;
            const appId = 'work-management-app'; // Example App ID

            const collections = ['shortcuts', 'tasks', 'notes', 'reminders'];
            collections.forEach(col => {
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/${col}`), orderBy('createdAt', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    switch(col) {
                        case 'shortcuts': allShortcuts = data; renderShortcuts(); break;
                        case 'tasks': allTasks = data; renderTasks(); break;
                        case 'notes': allNotes = data; renderNotes(); break;
                        case 'reminders': allReminders = data; renderReminders(); break;
                    }
                    renderOverview(); // Update overview whenever any data changes
                }, (error) => {
                    console.error(`Error listening to ${col}:`, error);
                });

                // Store unsubscribe functions to call on logout
                if (col === 'shortcuts') unsubscribeShortcuts = unsubscribe;
                if (col === 'tasks') unsubscribeTasks = unsubscribe;
                if (col === 'notes') unsubscribeNotes = unsubscribe;
                if (col === 'reminders') unsubscribeReminders = unsubscribe;
            });
        }
        
        // --- RENDER FUNCTIONS (Templates for each section) ---

        function renderSection(sectionId, title, addButtonHTML, contentHTML) {
            const container = document.getElementById(`${sectionId}-section`);
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">${title}</h2>
                    ${addButtonHTML}
                </div>
                ${contentHTML}
            `;
        }
        
        function renderShortcuts(shortcuts = allShortcuts) {
             renderSection('shortcuts', 'Shortcuts', 
                `<button onclick="openModal('shortcut')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Shortcut</button>`,
                `<div id="shortcuts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${shortcuts.map(s => `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between">
                            <a href="${s.url}" target="_blank" class="flex items-center space-x-3 group">
                                <img src="https://www.google.com/s2/favicons?domain=${s.url}&sz=32" alt="favicon" class="w-8 h-8">
                                <span class="font-medium group-hover:text-indigo-500">${s.name}</span>
                            </a>
                            <button onclick="confirmDeleteItem('shortcuts', '${s.id}')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `).join('')}
                </div>`
            );
        }

        function renderTasks(tasks = allTasks) {
            const notStarted = tasks.filter(t => t.status === 'not-started');
            const inProgress = tasks.filter(t => t.status === 'in-progress');
            const completed = tasks.filter(t => t.status === 'completed');

            const kanbanHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderKanbanColumn('Not Started', 'not-started', notStarted)}
                    ${renderKanbanColumn('In Progress', 'in-progress', inProgress)}
                    ${renderKanbanColumn('Completed', 'completed', completed)}
                </div>
            `;
            
            renderSection('tasks', 'Task Board', 
                `<button onclick="openModal('task')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Task</button>`,
                kanbanHTML
            );
            
            // Add drag and drop event listeners after rendering
            setupDragAndDrop();
        }

        function renderKanbanColumn(title, status, tasks) {
            return `
                <div class="bg-gray-200 dark:bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold mb-4 text-lg">${title} (${tasks.length})</h3>
                    <div class="kanban-column space-y-4" data-status="${status}">
                        ${tasks.map(task => `
                            <div class="task-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-grab" draggable="true" data-id="${task.id}">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-semibold">${task.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full ${getPriorityClass(task.priority)}">${task.priority}</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${task.description}</p>
                                <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">
                                    <span>Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
                                     <button onclick="confirmDeleteItem('tasks', '${task.id}')" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 hover:text-red-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderNotes(notes = allNotes) {
            renderSection('notes', 'Notes', 
                `<button onclick="openModal('note')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Note</button>`,
                `<div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${notes.map(n => `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex flex-col h-full">
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-lg mb-2">${n.title}</h3>
                                <div class="flex space-x-2">
                                    <button onclick="togglePinNote('${n.id}', ${n.pinned || false})" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 ${n.pinned ? 'text-yellow-500' : ''}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button onclick="confirmDeleteItem('notes', '${n.id}')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 hover:text-red-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 flex-grow">${n.content.replace(/\n/g, '<br>')}</p>
                            <p class="text-xs text-gray-400 mt-4">${new Date(n.createdAt?.toDate()).toLocaleString()}</p>
                        </div>
                    `).join('')}
                </div>`
            );
        }

        function renderReminders(reminders = allReminders) {
             renderSection('reminders', 'Reminders', 
                `<button onclick="openModal('reminder')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Reminder</button>`,
                `<div id="reminders-list" class="space-y-3">
                    ${reminders.map(r => `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between">
                            <div>
                                <p class="font-medium">${r.title}</p>
                                <p class="text-sm text-gray-500">${new Date(r.dateTime).toLocaleString()}</p>
                            </div>
                             <button onclick="confirmDeleteItem('reminders', '${r.id}')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `).join('')}
                </div>`
            );
        }

        function renderOverview() {
            const container = document.getElementById('overview-section');
            const activeTasks = allTasks.filter(t => t.status !== 'completed').length;
            const upcomingReminders = allReminders.filter(r => new Date(r.dateTime) > new Date()).length;

            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">Active Tasks</h3>
                        <p class="text-4xl font-bold text-indigo-500">${activeTasks}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">Upcoming Reminders</h3>
                        <p class="text-4xl font-bold text-green-500">${upcomingReminders}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">Shortcuts</h3>
                        <p class="text-4xl font-bold text-blue-500">${allShortcuts.length}</p>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold">Notes</h3>
                        <p class="text-4xl font-bold text-yellow-500">${allNotes.length}</p>
                    </div>
                </div>
            `;
        }

        function renderProfile() {
            const user = auth.currentUser;
            if (!user) return;
            renderSection('profile', 'Profile', '', `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow max-w-lg mx-auto">
                    <div class="space-y-4">
                        <div>
                            <label for="displayName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Display Name</label>
                            <input type="text" id="displayName" value="${user.displayName || ''}" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="updateNameBtn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Update Name</button>
                        </div>
                        <div class="border-t dark:border-gray-600 pt-4">
                             <label for="currentPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Password</label>
                            <input type="password" id="currentPassword" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">New Password</label>
                            <input type="password" id="newPassword" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="updatePasswordBtn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Update Password</button>
                            <p id="password-message" class="text-sm mt-2"></p>
                        </div>
                    </div>
                </div>
            `);

            document.getElementById('updateNameBtn').addEventListener('click', async () => {
                const newName = document.getElementById('displayName').value;
                if (newName && newName !== user.displayName) {
                    await updateProfile(user, { displayName: newName });
                    updateUserInfo(user);
                    alert('Display name updated!');
                }
            });

            document.getElementById('updatePasswordBtn').addEventListener('click', async () => {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const messageEl = document.getElementById('password-message');
                
                if(!currentPassword || !newPassword) {
                    messageEl.textContent = "Please fill in both password fields.";
                    messageEl.className = 'text-sm mt-2 text-red-500';
                    return;
                }

                try {
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPassword);
                    messageEl.textContent = 'Password updated successfully!';
                    messageEl.className = 'text-sm mt-2 text-green-500';
                } catch (error) {
                    messageEl.textContent = `Error: ${error.message}`;
                    messageEl.className = 'text-sm mt-2 text-red-500';
                }
            });
        }
        
        // --- MODAL LOGIC ---
        const modal = document.getElementById('item-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const saveBtn = document.getElementById('modal-save-btn');
        
        function getFormHTML(type) {
            switch (type) {
                case 'shortcut':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label for="shortcutName" class="block text-sm font-medium">Name</label>
                                <input type="text" id="shortcutName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="shortcutUrl" class="block text-sm font-medium">URL</label>
                                <input type="url" id="shortcutUrl" placeholder="https://example.com" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                        </div>`;
                case 'task':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label for="taskTitle" class="block text-sm font-medium">Title</label>
                                <input type="text" id="taskTitle" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                             <div>
                                <label for="taskDesc" class="block text-sm font-medium">Description</label>
                                <textarea id="taskDesc" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="taskDueDate" class="block text-sm font-medium">Due Date</label>
                                    <input type="date" id="taskDueDate" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="taskPriority" class="block text-sm font-medium">Priority</label>
                                    <select id="taskPriority" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                                        <option>Low</option>
                                        <option>Medium</option>
                                        <option>High</option>
                                    </select>
                                </div>
                            </div>
                        </div>`;
                case 'note':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label for="noteTitle" class="block text-sm font-medium">Title</label>
                                <input type="text" id="noteTitle" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                             <div>
                                <label for="noteContent" class="block text-sm font-medium">Content</label>
                                <textarea id="noteContent" rows="5" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500"></textarea>
                            </div>
                        </div>`;
                case 'reminder':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label for="reminderTitle" class="block text-sm font-medium">Title</label>
                                <input type="text" id="reminderTitle" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="reminderDateTime" class="block text-sm font-medium">Date & Time</label>
                                <input type="datetime-local" id="reminderDateTime" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                        </div>`;
                default:
                    return '';
            }
        }
        
        window.openModal = (type) => {
            modalTitle.textContent = `Add New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            modalBody.innerHTML = getFormHTML(type);
            saveBtn.onclick = () => saveItem(type);

            modal.classList.remove('hidden', 'scale-95');
            modalOverlay.classList.remove('hidden');
            modal.classList.add('scale-100');
        }

        function closeModal() {
            modal.classList.add('scale-95');
            modal.classList.add('hidden');
            modalOverlay.classList.add('hidden');
            modalBody.innerHTML = ''; // Clear content
        }

        document.getElementById('modal-close-btn').onclick = closeModal;
        document.getElementById('modal-cancel-btn').onclick = closeModal;
        modalOverlay.onclick = closeModal;

        async function saveItem(type) {
            if (!currentUserId) return;
            const appId = 'work-management-app';
            const collectionPath = `artifacts/${appId}/users/${currentUserId}/${type}s`;
            let data = {
                userId: currentUserId,
                createdAt: serverTimestamp()
            };

            try {
                switch(type) {
                    case 'shortcut':
                        data.name = document.getElementById('shortcutName').value;
                        data.url = document.getElementById('shortcutUrl').value;
                        if (!data.name || !data.url) throw new Error("Name and URL are required.");
                        break;
                    case 'task':
                        data.title = document.getElementById('taskTitle').value;
                        data.description = document.getElementById('taskDesc').value;
                        data.dueDate = document.getElementById('taskDueDate').value;
                        data.priority = document.getElementById('taskPriority').value;
                        data.status = 'not-started';
                         if (!data.title || !data.dueDate) throw new Error("Title and due date are required.");
                        break;
                    case 'note':
                        data.title = document.getElementById('noteTitle').value;
                        data.content = document.getElementById('noteContent').value;
                        data.pinned = false;
                        if (!data.title) throw new Error("Title is required.");
                        break;
                    case 'reminder':
                        data.title = document.getElementById('reminderTitle').value;
                        data.dateTime = document.getElementById('reminderDateTime').value;
                        if (!data.title || !data.dateTime) throw new Error("Title and date/time are required.");
                        break;
                }
                
                await addDoc(collection(db, collectionPath), data);
                closeModal();
            } catch (error) {
                alert(`Error saving ${type}: ${error.message}`);
                console.error("Error adding document: ", error);
            }
        }

        // --- DELETE LOGIC ---
        const deleteModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        window.confirmDeleteItem = (collectionName, docId) => {
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
            
            confirmDeleteBtn.onclick = async () => {
                const appId = 'work-management-app';
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, docId);
                await deleteDoc(docRef);
                closeDeleteModal();
            };
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }
        cancelDeleteBtn.onclick = closeDeleteModal;


        // --- DARK MODE ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const sunIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
        const moonIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
        
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                darkModeToggle.innerHTML = sunIcon;
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggle.innerHTML = moonIcon;
            }
        };

        // Load theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        darkModeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        // --- HELPERS ---
        function getPriorityClass(priority) {
            switch(priority?.toLowerCase()) {
                case 'high': return 'bg-red-200 text-red-800 dark:bg-red-800 dark:text-red-200';
                case 'medium': return 'bg-yellow-200 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-200';
                case 'low': return 'bg-green-200 text-green-800 dark:bg-green-800 dark:text-green-200';
                default: return 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200';
            }
        }

        // --- DRAG AND DROP ---
        function setupDragAndDrop() {
            const tasks = document.querySelectorAll('.task-card');
            const columns = document.querySelectorAll('.kanban-column');
            let draggedItem = null;

            tasks.forEach(task => {
                task.addEventListener('dragstart', () => {
                    draggedItem = task;
                    setTimeout(() => task.classList.add('dragging'), 0);
                });
                task.addEventListener('dragend', () => {
                    task.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                });
                column.addEventListener('drop', async e => {
                    e.preventDefault();
                    if (draggedItem) {
                        column.appendChild(draggedItem);
                        const taskId = draggedItem.dataset.id;
                        const newStatus = column.dataset.status;
                        const appId = 'work-management-app';
                        const taskRef = doc(db, `artifacts/${appId}/users/${currentUserId}/tasks`, taskId);
                        await updateDoc(taskRef, { status: newStatus });
                    }
                });
            });
        }
        
        // Pin Note
        window.togglePinNote = async (noteId, isPinned) => {
            const appId = 'work-management-app';
            const noteRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes`, noteId);
            await updateDoc(noteRef, { pinned: !isPinned });
        };
        
        // Global Search
        document.getElementById('global-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            renderShortcuts(allShortcuts.filter(s => s.name.toLowerCase().includes(searchTerm)));
            renderTasks(allTasks.filter(t => t.title.toLowerCase().includes(searchTerm) || t.description.toLowerCase().includes(searchTerm)));
            renderNotes(allNotes.filter(n => n.title.toLowerCase().includes(searchTerm) || n.content.toLowerCase().includes(searchTerm)));
            renderReminders(allReminders.filter(r => r.title.toLowerCase().includes(searchTerm)));
        });

        // Initial render of dynamic sections on load
        renderProfile(); // Render profile section template
    </script>
</body>
</html>

