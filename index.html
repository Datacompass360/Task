<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Management Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœ…</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .task-card, .note-card, .shortcut-item, .reminder-item, .stat-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover, .note-card:hover, .shortcut-item:hover, .reminder-item:hover, .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .task-card {
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .kanban-column {
            min-height: 400px;
        }
        .dragging {
            opacity: 0.5;
            border: 2px dashed #3b82f6;
        }
        .drag-over {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .priority-low { background-color: #d1fae5; color: #065f46; border-left-color: #10b981; }
        .priority-medium { background-color: #fef3c7; color: #92400e; border-left-color: #f59e0b; }
        .priority-high { background-color: #fee2e2; color: #991b1b; border-left-color: #ef4444; }
        
        .dark .priority-low { background-color: #064e3b; color: #a7f3d0; }
        .dark .priority-medium { background-color: #78350f; color: #fde68a; }
        .dark .priority-high { background-color: #7f1d1d; color: #fecaca; }

        .note-card.pinned {
            border-left: 4px solid #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- App Container -->
    <div id="app">
        <!-- Login Page -->
        <div id="login-page" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="mt-6 text-3xl font-bold text-gray-900 dark:text-white">Welcome Back</h2>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Sign in to manage your work</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div class="relative">
                         <input id="email" name="email" type="email" required class="peer h-10 w-full border-b-2 border-gray-300 text-gray-900 dark:text-white dark:border-gray-600 dark:bg-gray-800 focus:outline-none focus:border-blue-600 placeholder-transparent" placeholder="Email address">
                         <label for="email" class="absolute left-0 -top-3.5 text-gray-600 dark:text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-blue-600 peer-focus:text-sm">Email address</label>
                    </div>
                    <div class="relative">
                         <input id="password" name="password" type="password" required class="peer h-10 w-full border-b-2 border-gray-300 text-gray-900 dark:text-white dark:border-gray-600 dark:bg-gray-800 focus:outline-none focus:border-blue-600 placeholder-transparent" placeholder="Password">
                         <label for="password" class="absolute left-0 -top-3.5 text-gray-600 dark:text-gray-400 text-sm transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-blue-600 peer-focus:text-sm">Password</label>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm text-center"></p>
                    <div class="flex items-center justify-between">
                         <a href="#" id="toggle-signup" class="text-sm text-blue-600 hover:underline">Create an account</a>
                    </div>
                    <div>
                        <button type="submit" id="auth-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Sign in
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="flex h-screen bg-gray-100 dark:bg-gray-900">
                <!-- Sidebar -->
                <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col p-4 transition-all duration-300 -translate-x-full md:translate-x-0">
                    <div class="flex items-center mb-8">
                        <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h1 class="ml-3 text-2xl font-bold text-gray-800 dark:text-white">WorkFlow</h1>
                    </div>
                    <nav class="flex-1 space-y-2">
                         <a href="#overview" class="nav-link sidebar-link flex items-center p-3 rounded-lg">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
                            Overview
                        </a>
                        <a href="#shortcuts" class="nav-link sidebar-link flex items-center p-3 rounded-lg">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                            Shortcuts
                        </a>
                        <a href="#tasks" class="nav-link sidebar-link flex items-center p-3 rounded-lg">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            Tasks
                        </a>
                        <a href="#notes" class="nav-link sidebar-link flex items-center p-3 rounded-lg">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Notes
                        </a>
                        <a href="#reminders" class="nav-link sidebar-link flex items-center p-3 rounded-lg">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            Reminders
                        </a>
                    </nav>
                    <div class="mt-auto">
                        <a href="#profile" class="nav-link sidebar-link flex items-center p-3 rounded-lg mb-2">
                           <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                            Profile
                         </a>
                         <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-700">
                              <p id="user-display-name" class="text-sm font-medium text-center truncate"></p>
                         </div>
                         <button id="logout-button" class="w-full mt-4 flex items-center justify-center p-3 rounded-lg text-red-500 hover:bg-red-500 hover:text-white transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                         </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 shadow">
                        <button id="menu-button" class="md:hidden text-gray-600 dark:text-gray-300">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <div class="relative w-full max-w-md">
                            <input id="search-bar" type="text" placeholder="Search everywhere..." class="w-full py-2 pl-10 pr-4 rounded-full bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                         <div class="flex items-center space-x-4 ml-4">
                            <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            </button>
                        </div>
                    </header>
                    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6">
                        <div id="content">
                            <!-- Content for each section will be injected here -->
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Templates -->
    <template id="overview-template">
        <div>
            <h2 class="text-3xl font-bold mb-6">Dashboard Overview</h2>
            <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-4">Upcoming Reminders</h3>
                    <div id="overview-reminders-list" class="space-y-3"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-4">Weekly Task Progress</h3>
                    <div id="overview-tasks-progress"></div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="profile-template">
        <div>
             <h2 class="text-3xl font-bold mb-6">User Profile</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                     <h3 class="font-semibold text-xl mb-4">Profile Information</h3>
                     <form id="profile-form" class="space-y-4">
                         <div>
                            <label for="displayName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
                            <input type="text" id="displayName" name="displayName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                         </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                            <p id="profile-email" class="text-gray-500 dark:text-gray-400"></p>
                         </div>
                         <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Save Changes</button>
                         <p id="profile-success" class="text-green-500 text-sm text-center"></p>
                     </form>
                 </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                     <h3 class="font-semibold text-xl mb-4">Change Password</h3>
                     <form id="password-form" class="space-y-4">
                          <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                         </div>
                         <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Update Password</button>
                         <p id="password-success" class="text-green-500 text-sm text-center"></p>
                         <p id="password-error" class="text-red-500 text-sm text-center"></p>
                     </form>
                 </div>
             </div>
        </div>
    </template>
    
    <template id="search-results-template">
         <div>
            <h2 class="text-3xl font-bold mb-6">Search Results for "<span id="search-term-display"></span>"</h2>
            <div id="search-results-container" class="space-y-4"></div>
        </div>
    </template>

    <template id="shortcuts-template">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Shortcuts</h2>
                <button id="add-shortcut-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Add Shortcut</button>
            </div>
            <div id="shortcuts-list" class="space-y-3"></div>
        </div>
    </template>
    
    <template id="tasks-template">
         <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Task Board</h2>
                <button id="add-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Add Task</button>
            </div>
            <div id="tasks-board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-200 dark:bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-4 text-center">Not Started</h3>
                    <div id="tasks-not-started" class="kanban-column space-y-4" data-status="Not Started"></div>
                </div>
                 <div class="bg-gray-200 dark:bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-4 text-center">In Progress</h3>
                    <div id="tasks-in-progress" class="kanban-column space-y-4" data-status="In Progress"></div>
                </div>
                 <div class="bg-gray-200 dark:bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-4 text-center">Completed</h3>
                    <div id="tasks-completed" class="kanban-column space-y-4" data-status="Completed"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="notes-template">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Notes</h2>
                <button id="add-note-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Add Note</button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </template>

    <template id="reminders-template">
         <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Reminders</h2>
                <button id="add-reminder-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Add Reminder</button>
            </div>
            <div id="reminders-list" class="space-y-4"></div>
        </div>
    </template>

    <!-- Modals -->
    <div id="modal-container"></div>
    
    <template id="modal-template">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md m-4 transform transition-all opacity-0 -translate-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold"></h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="modal-form">
                    <!-- Form content goes here -->
                </form>
            </div>
        </div>
    </template>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            updateProfile,
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs,
            onSnapshot,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyB6W3bpYgKinmHbs-hgf2F_W3BQSwxfAwk",
                authDomain: "customer-experience-controls-2.firebaseapp.com",
                projectId: "customer-experience-controls-2",
                storageBucket: "customer-experience-controls-2.appspot.com",
                messagingSenderId: "144837337826",
                appId: "1:144837337826:web:63c952a42599279d4534bb",
                measurementId: "G-V4PF0XBT2J"
            };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUserId = null;
        let unsubscribeListeners = [];
        let allDataCache = { shortcuts: [], tasks: [], notes: [], reminders: [] };

        // App State
        let isSignUp = false;

        // UI Elements
        const loginPage = document.getElementById('login-page');
        const dashboard = document.getElementById('dashboard');
        const authForm = document.getElementById('login-form');
        const authButton = document.getElementById('auth-button');
        const toggleSignupLink = document.getElementById('toggle-signup');
        const authError = document.getElementById('auth-error');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutButton = document.getElementById('logout-button');
        const contentContainer = document.getElementById('content');
        const navLinks = document.querySelectorAll('.nav-link');
        const searchBar = document.getElementById('search-bar');
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        
        const applyTheme = (theme) => {
             if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
        };

        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            localStorage.theme = newTheme;
            applyTheme(newTheme);
            if (currentUserId) {
                const settingsRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, 'theme');
                setDoc(settingsRef, { mode: newTheme });
            }
        });
        
        const fetchAndApplyThemePreference = async () => {
            if (currentUserId) {
                const settingsRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, 'theme');
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists() && docSnap.data().mode) {
                    localStorage.theme = docSnap.data().mode;
                    applyTheme(docSnap.data().mode);
                    return;
                }
            }
            // Fallback to local storage or system preference
             if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        };

        // Mobile sidebar toggle
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !menuButton.contains(e.target) && !sidebar.classList.contains('-translate-x-full')) {
                 sidebar.classList.add('-translate-x-full');
            }
        });

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userDisplayName.textContent = user.displayName || user.email;
                loginPage.classList.add('hidden');
                dashboard.classList.remove('hidden');
                fetchAndApplyThemePreference();
                navigateTo(window.location.hash || '#overview');
                setupRealtimeListeners();
            } else {
                currentUserId = null;
                loginPage.classList.remove('hidden');
                dashboard.classList.add('hidden');
                // Cleanup listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
            }
        });
        
        // Auto-login with provided token if available
        (async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Failed to sign in with custom token:", error);
                    await signInAnonymously(auth);
                }
            } else if (!auth.currentUser) {
                // Only show login form if no token and no user
                loginPage.classList.remove('hidden');
            }
        })();


        const updateAuthUI = () => {
            if (isSignUp) {
                authButton.textContent = 'Create account';
                toggleSignupLink.textContent = 'Already have an account? Sign in';
            } else {
                authButton.textContent = 'Sign in';
                toggleSignupLink.textContent = 'Create an account';
            }
            authError.textContent = '';
        };

        toggleSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUp = !isSignUp;
            updateAuthUI();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';
            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        // --- ROUTING ---
        const navigateTo = (hash) => {
            const section = hash.substring(1).split('?')[0]; // Ignore query params for routing
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === `#${section}`) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            switch(section) {
                case 'tasks': renderSection('tasks'); break;
                case 'notes': renderSection('notes'); break;
                case 'reminders': renderSection('reminders'); break;
                case 'shortcuts': renderSection('shortcuts'); break;
                case 'profile': renderSection('profile'); break;
                case 'overview':
                default:
                    renderSection('overview');
                    break;
            }
        };

        window.addEventListener('hashchange', () => navigateTo(window.location.hash));

        const renderSection = (section) => {
             const template = document.getElementById(`${section}-template`);
             if (template) {
                contentContainer.innerHTML = '';
                contentContainer.appendChild(template.content.cloneNode(true));
                setupSectionUI(section);
             }
        }
        
        const setupSectionUI = (section) => {
             switch(section) {
                case 'overview': renderOverview(); break;
                case 'profile': renderProfile(); break;
                case 'shortcuts': document.getElementById('add-shortcut-btn').addEventListener('click', () => openModal('shortcut')); break;
                case 'tasks': 
                    document.getElementById('add-task-btn').addEventListener('click', () => openModal('task'));
                    setupDragAndDrop();
                    renderTasks(allDataCache.tasks);
                    break;
                case 'notes': document.getElementById('add-note-btn').addEventListener('click', () => openModal('note')); break;
                case 'reminders': document.getElementById('add-reminder-btn').addEventListener('click', () => openModal('reminder')); break;
            }
        }
        
        // --- REALTIME LISTENERS ---
        const setupRealtimeListeners = () => {
             if (!currentUserId) return;
             
             unsubscribeListeners.forEach(unsub => unsub());
             unsubscribeListeners = [];

             const collections = ['shortcuts', 'tasks', 'notes', 'reminders'];
             collections.forEach(col => {
                 const q = query(getCollectionRef(col));
                 const unsub = onSnapshot(q, (snapshot) => {
                     allDataCache[col] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     const currentSection = (window.location.hash.substring(1) || 'overview').split('?')[0];
                     
                     switch (col) {
                         case 'shortcuts': if(currentSection === 'shortcuts') renderShortcuts(allDataCache.shortcuts); break;
                         case 'tasks': if(currentSection === 'tasks') renderTasks(allDataCache.tasks); break;
                         case 'notes': if(currentSection === 'notes') renderNotes(allDataCache.notes); break;
                         case 'reminders': if(currentSection === 'reminders') renderReminders(allDataCache.reminders); break;
                     }
                     if(currentSection === 'overview') renderOverview();
                 }, (error) => {
                     console.error(`Error listening to ${col}:`, error);
                 });
                 unsubscribeListeners.push(unsub);
             });
        }
        
        // --- RENDERING FUNCTIONS ---
        const renderShortcuts = (shortcuts) => {
            const list = document.getElementById('shortcuts-list');
            if (!list) return;
            list.innerHTML = shortcuts.length ? '' : '<p class="text-gray-500">No shortcuts yet. Add one to get started!</p>';
            shortcuts.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                const item = document.createElement('div');
                item.className = 'shortcut-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between';
                const domain = new URL(s.url).hostname;
                item.innerHTML = `
                    <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="flex items-center flex-1 truncate text-blue-500 hover:underline">
                        <img src="https://www.google.com/s2/favicons?sz=32&domain_url=${domain}" alt="favicon" class="w-6 h-6 mr-4 rounded" onerror="this.style.display='none'">
                        <div class="truncate">
                          <span class="font-semibold">${s.name}</span>
                          <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${s.url}</p>
                        </div>
                    </a>
                    <div class="flex items-center space-x-2 ml-4">
                        <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${s.id}"><svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${s.id}"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                item.querySelector('.edit-btn').addEventListener('click', () => openModal('shortcut', s));
                item.querySelector('.delete-btn').addEventListener('click', () => confirmDelete('shortcuts', s.id));
                list.appendChild(item);
            });
        }
        
        const renderTasks = (tasks) => {
            const notStartedCol = document.getElementById('tasks-not-started');
            const inProgressCol = document.getElementById('tasks-in-progress');
            const completedCol = document.getElementById('tasks-completed');
            if (!notStartedCol) return; 

            notStartedCol.innerHTML = '';
            inProgressCol.innerHTML = '';
            completedCol.innerHTML = '';

            tasks.forEach(t => {
                const card = document.createElement('div');
                card.id = `task-${t.id}`;
                card.draggable = true;
                const isOverdue = t.status !== 'Completed' && moment(t.dueDate).isBefore(moment(), 'day');
                const priorityClass = `priority-${(t.priority || 'low').toLowerCase()}`;

                card.className = `task-card bg-white dark:bg-gray-800 p-4 rounded-lg shadow border-l-4 ${priorityClass}`;
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-md">${t.title}</h4>
                             <span class="text-xs font-semibold px-2 py-1 rounded-full ${priorityClass}">${t.priority}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">${t.description || ''}</p>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <p class="font-medium ${isOverdue ? 'text-red-500' : 'text-gray-500 dark:text-gray-400'}">
                            <svg class="w-4 h-4 inline -mt-1 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            ${moment(t.dueDate).format('MMM D')}
                        </p>
                         <div class="flex items-center space-x-1">
                             <button class="edit-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${t.id}"><svg class="w-4 h-4 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                             <button class="delete-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${t.id}"><svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                         </div>
                    </div>
                `;
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', t.id);
                    setTimeout(() => card.classList.add('dragging'), 0);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));

                card.querySelector('.edit-btn').addEventListener('click', () => openModal('task', t));
                card.querySelector('.delete-btn').addEventListener('click', () => confirmDelete('tasks', t.id));

                if (t.status === 'In Progress') inProgressCol.appendChild(card);
                else if (t.status === 'Completed') completedCol.appendChild(card);
                else notStartedCol.appendChild(card);
            });
        }
        
        const renderNotes = (notes) => {
            const list = document.getElementById('notes-list');
            if (!list) return;
            list.innerHTML = notes.length ? '' : '<p class="text-gray-500 col-span-full">Your mind is clear! Add a note to capture your thoughts.</p>';
            notes.sort((a,b) => (b.pinned || false) - (a.pinned || false) || (b.updatedAt?.toDate() || 0) - (a.updatedAt?.toDate() || 0)).forEach(n => {
                const card = document.createElement('div');
                card.className = `note-card bg-white dark:bg-gray-800 p-5 rounded-lg shadow flex flex-col h-64 ${n.pinned ? 'pinned' : ''}`;
                card.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                         <div class="flex justify-between items-center">
                            <h4 class="font-bold text-lg truncate">${n.title}</h4>
                            ${n.pinned ? '<svg class="w-5 h-5 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.305-.772 1.626 0l1.863 4.485c.08.194.26.328.469.349l4.95.719c.823.119 1.15 1.131.558 1.7L16.4 13.9c-.147.143-.215.349-.183.545l.865 4.93c.14 0.806-.714 1.423-1.442 1.021L12.1 18.25c-.193-.102-.428-.102-.622 0l-4.434 2.33c-.728.402-1.582-.215-1.442-1.02l.865-4.931c.032-.195-.036-.401-.183-.545L1.47 10.137c-.592-.57-.265-1.581.558-1.7l4.95-.719a.525.525 0 00.469-.35L9.309 2.884z" clip-rule="evenodd" /></svg>' : ''}
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 mt-2 text-sm whitespace-pre-wrap break-words">${(n.content || '').substring(0, 200)}${n.content && n.content.length > 200 ? '...' : ''}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center text-xs text-gray-500">
                        <span>${n.updatedAt ? moment(n.updatedAt.toDate()).format('MMM D, h:mm A') : 'No date'}</span>
                         <div class="flex items-center space-x-1">
                             <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${n.id}"><svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                             <button class="delete-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${n.id}"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                         </div>
                    </div>
                `;
                card.querySelector('.edit-btn').addEventListener('click', () => openModal('note', n));
                card.querySelector('.delete-btn').addEventListener('click', () => confirmDelete('notes', n.id));
                list.appendChild(card);
            });
        }
        
        const renderReminders = (reminders) => {
            const list = document.getElementById('reminders-list');
            if (!list) return;
            list.innerHTML = reminders.length ? '' : '<p class="text-gray-500">No upcoming reminders.</p>';
            reminders.sort((a,b) => new Date(a.datetime) - new Date(b.datetime)).forEach(r => {
                const item = document.createElement('div');
                const isPast = moment(r.datetime).isBefore(moment());
                item.className = `reminder-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex items-center justify-between ${isPast ? 'opacity-60' : ''}`;
                item.innerHTML = `
                     <div class="flex-1">
                        <p class="font-semibold text-lg ${isPast ? 'line-through' : ''}">${r.title}</p>
                        <p class="text-sm text-blue-500 font-medium">${moment(r.datetime).format('dddd, MMMM Do YYYY, h:mm a')}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${moment(r.datetime).fromNow()}</p>
                     </div>
                     <div class="flex items-center space-x-2 ml-4">
                        <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${r.id}"><svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${r.id}"><svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                item.querySelector('.edit-btn').addEventListener('click', () => openModal('reminder', r));
                item.querySelector('.delete-btn').addEventListener('click', () => confirmDelete('reminders', r.id));
                list.appendChild(item);
            });
        }
        
        // --- MODAL & FORM HANDLING ---
        const modalContainer = document.getElementById('modal-container');

        const openModal = (type, data = {}) => {
            const template = document.getElementById('modal-template');
            modalContainer.innerHTML = '';
            modalContainer.appendChild(template.content.cloneNode(true));

            const modal = modalContainer.querySelector('.fixed');
            const modalContent = modalContainer.querySelector('div > div');
            const modalTitle = modalContainer.querySelector('h3');
            const form = modalContainer.querySelector('form');
            
            const isEditing = !!data.id;

            if (type === 'confirm') {
                modalTitle.textContent = data.title;
                form.innerHTML = `<p class="dark:text-gray-300">${data.message}</p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="close-modal-btn px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                    <button id="confirm-action-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
                </div>`;
                modal.querySelector('#confirm-action-btn').addEventListener('click', data.onConfirm);

            } else {
                 modalTitle.textContent = `${isEditing ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                form.innerHTML = getFormFields(type, data);
                form.innerHTML += `<button type="submit" class="w-full mt-4 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">${isEditing ? 'Save Changes' : `Add ${type}`}</button>`;
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const itemData = Object.fromEntries(formData.entries());
                    
                    if(type === 'note') {
                        itemData.updatedAt = new Date();
                        itemData.pinned = form.pinned ? form.pinned.checked : false;
                    }

                    if (isEditing) {
                        updateItem(type + 's', data.id, itemData);
                    } else {
                        if(type === 'task') itemData.status = 'Not Started'; 
                        addItem(type + 's', itemData);
                    }
                    closeModal();
                });
            }
            
            modalContainer.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('opacity-0', '-translate-y-4');
            });
        };

        const closeModal = () => {
            const modal = modalContainer.querySelector('.fixed');
            if(modal) {
                 const modalContent = modal.querySelector('div > div');
                 modalContent.classList.add('opacity-0', '-translate-y-4');
                 modal.classList.add('opacity-0');
                 setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            }
        };

        const getFormFields = (type, data) => {
            const commonInputClasses = "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500";
            const commonLabelClasses = "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1";
            switch(type) {
                case 'shortcut':
                    return `
                        <div class="space-y-4">
                            <div><label for="name" class="${commonLabelClasses}">Name</label><input type="text" id="name" name="name" value="${data.name || ''}" required class="${commonInputClasses}"></div>
                            <div><label for="url" class="${commonLabelClasses}">URL</label><input type="url" id="url" name="url" value="${data.url || ''}" required class="${commonInputClasses}" placeholder="https://example.com"></div>
                        </div>`;
                case 'task':
                    const isEditing = !!data.id;
                    return `
                        <div class="space-y-4">
                            <div><label for="title" class="${commonLabelClasses}">Title</label><input type="text" id="title" name="title" value="${data.title || ''}" required class="${commonInputClasses}"></div>
                            <div><label for="description" class="${commonLabelClasses}">Description</label><textarea id="description" name="description" class="${commonInputClasses}">${data.description || ''}</textarea></div>
                            <div><label for="dueDate" class="${commonLabelClasses}">Due Date</label><input type="date" id="dueDate" name="dueDate" value="${data.dueDate || ''}" required class="${commonInputClasses}"></div>
                            <div><label for="priority" class="${commonLabelClasses}">Priority</label>
                                <select id="priority" name="priority" class="${commonInputClasses}">
                                    <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                                    <option value="Medium" ${data.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                                </select>
                            </div>
                             ${isEditing ? `<div><label for="status" class="${commonLabelClasses}">Status</label>
                                <select id="status" name="status" class="${commonInputClasses}">
                                    <option value="Not Started" ${data.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                    <option value="In Progress" ${data.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${data.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>` : ''}
                        </div>`;
                case 'note':
                    return `
                        <div class="space-y-4">
                            <div><label for="title" class="${commonLabelClasses}">Title</label><input type="text" id="title" name="title" value="${data.title || ''}" required class="${commonInputClasses}"></div>
                            <div><label for="content" class="${commonLabelClasses}">Content</label><textarea id="content" name="content" rows="6" class="${commonInputClasses}">${data.content || ''}</textarea></div>
                             <div class="flex items-center">
                                <input id="pinned" name="pinned" type="checkbox" ${data.pinned ? 'checked' : ''} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="pinned" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Pin this note</label>
                            </div>
                        </div>`;
                case 'reminder':
                    return `
                        <div class="space-y-4">
                            <div><label for="title" class="${commonLabelClasses}">Title</label><input type="text" id="title" name="title" value="${data.title || ''}" required class="${commonInputClasses}"></div>
                            <div><label for="datetime" class="${commonLabelClasses}">Date & Time</label><input type="datetime-local" id="datetime" name="datetime" value="${data.datetime || ''}" required class="${commonInputClasses}"></div>
                        </div>`;
            }
            return '';
        }
        
        // --- CRUD OPERATIONS ---
        const getCollectionRef = (collectionName) => collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`);
        
        const addItem = async (collectionName, data) => { if (!currentUserId) return; try { await addDoc(getCollectionRef(collectionName), data); } catch (e) { console.error("Error adding: ", e); } };
        const updateItem = async (collectionName, id, data) => { if (!currentUserId) return; try { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, id), data); } catch (e) { console.error("Error updating: ", e); } };
        const deleteItem = async (collectionName, id) => { if (!currentUserId) return; try { await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`, id)); } catch (e) { console.error("Error deleting: ", e); } };
        
        // --- TASK DRAG AND DROP ---
        const setupDragAndDrop = () => {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = column.dataset.status;
                    const draggedElement = document.getElementById(`task-${taskId}`);
                    if(draggedElement && draggedElement.parentElement !== column) {
                         column.appendChild(draggedElement);
                         updateItem('tasks', taskId, { status: newStatus });
                    }
                });
            });
        }
        
        // --- GLOBAL SEARCH ---
        let searchTimeout;
        searchBar.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value.toLowerCase().trim();
            if(searchTerm.length > 2) {
                searchTimeout = setTimeout(() => performGlobalSearch(searchTerm), 300);
            } else if (searchTerm.length === 0) {
                 navigateTo(window.location.hash || '#overview');
            }
        });

        const performGlobalSearch = (term) => {
            const results = [];
            allDataCache.shortcuts.forEach(s => { if(s.name.toLowerCase().includes(term) || s.url.toLowerCase().includes(term)) results.push({type: 'Shortcut', data: s}); });
            allDataCache.tasks.forEach(t => { if((t.title && t.title.toLowerCase().includes(term)) || (t.description && t.description.toLowerCase().includes(term))) results.push({type: 'Task', data: t}); });
            allDataCache.notes.forEach(n => { if((n.title && n.title.toLowerCase().includes(term)) || (n.content && n.content.toLowerCase().includes(term))) results.push({type: 'Note', data: n}); });
            allDataCache.reminders.forEach(r => { if(r.title && r.title.toLowerCase().includes(term)) results.push({type: 'Reminder', data: r}); });
            renderSearchResults(results, term);
        };
        
        const renderSearchResults = (results, term) => {
            renderSection('search-results');
            document.getElementById('search-term-display').textContent = term;
            const container = document.getElementById('search-results-container');
            container.innerHTML = results.length ? '' : '<p class="text-gray-500">No results found.</p>';
            
            results.forEach(res => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow';
                let content = `<div class="flex justify-between items-center"><h4 class="font-bold">${res.data.title || res.data.name}</h4><span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700">${res.type}</span></div>`;
                if(res.type === 'Shortcut') content += `<p class="text-sm text-gray-500 truncate">${res.data.url}</p>`;
                if(res.type === 'Task') content += `<p class="text-sm text-gray-500">${res.data.description || ''}</p>`;
                if(res.type === 'Note') content += `<p class="text-sm text-gray-500 truncate">${res.data.content || ''}</p>`;
                div.innerHTML = content;
                container.appendChild(div);
            });
        };
        
        // --- OVERVIEW & PROFILE ---
        const renderOverview = () => {
            const statsGrid = document.getElementById('stats-grid');
            const remindersList = document.getElementById('overview-reminders-list');
            const tasksProgress = document.getElementById('overview-tasks-progress');

            if (!statsGrid) return;
            
            const activeTasks = allDataCache.tasks.filter(t => t.status !== 'Completed').length;
            const upcomingReminders = allDataCache.reminders.filter(r => moment(r.datetime).isAfter(moment())).length;

            statsGrid.innerHTML = `
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h4 class="text-gray-500 dark:text-gray-400">Active Tasks</h4><p class="text-3xl font-bold">${activeTasks}</p></div>
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h4 class="text-gray-500 dark:text-gray-400">Upcoming Reminders</h4><p class="text-3xl font-bold">${upcomingReminders}</p></div>
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h4 class="text-gray-500 dark:text-gray-400">Notes</h4><p class="text-3xl font-bold">${allDataCache.notes.length}</p></div>
                <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h4 class="text-gray-500 dark:text-gray-400">Shortcuts</h4><p class="text-3xl font-bold">${allDataCache.shortcuts.length}</p></div>
            `;
            
            remindersList.innerHTML = '';
            const sortedReminders = [...allDataCache.reminders]
                .filter(r => moment(r.datetime).isAfter(moment()))
                .sort((a,b) => new Date(a.datetime) - new Date(b.datetime))
                .slice(0, 5);
            
            if(sortedReminders.length === 0) {
                remindersList.innerHTML = '<p class="text-gray-500 text-sm">No upcoming reminders.</p>';
            } else {
                 sortedReminders.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'text-sm';
                    item.innerHTML = `<p class="font-semibold">${r.title}</p><p class="text-gray-500 dark:text-gray-400">${moment(r.datetime).fromNow()}</p>`;
                    remindersList.appendChild(item);
                });
            }

            const weekStart = moment().startOf('week');
            const tasksThisWeek = allDataCache.tasks.filter(t => moment(t.dueDate).isAfter(weekStart));
            const completedThisWeek = tasksThisWeek.filter(t => t.status === 'Completed').length;
            const progress = tasksThisWeek.length > 0 ? Math.round((completedThisWeek / tasksThisWeek.length) * 100) : 0;
            
            tasksProgress.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold">${completedThisWeek} of ${tasksThisWeek.length} tasks completed</p>
                    <p class="font-bold text-lg">${progress}%</p>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full" style="width: ${progress}%"></div>
                </div>
            `;
        };
        
        const renderProfile = () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const profileForm = document.getElementById('profile-form');
            const passwordForm = document.getElementById('password-form');
            
            document.getElementById('displayName').value = user.displayName || '';
            document.getElementById('profile-email').textContent = user.email;

            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = profileForm.displayName.value;
                const successMsg = document.getElementById('profile-success');
                try {
                    await updateProfile(user, { displayName: newName });
                    userDisplayName.textContent = newName;
                    successMsg.textContent = "Profile updated successfully!";
                    setTimeout(() => successMsg.textContent = '', 3000);
                } catch(error) {
                    console.error("Profile update error:", error);
                }
            });

            passwordForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const newPassword = passwordForm.newPassword.value;
                 const successMsg = document.getElementById('password-success');
                 const errorMsg = document.getElementById('password-error');
                 successMsg.textContent = '';
                 errorMsg.textContent = '';
                 
                 try {
                     await updatePassword(user, newPassword);
                     successMsg.textContent = "Password updated successfully!";
                     passwordForm.reset();
                     setTimeout(() => successMsg.textContent = '', 3000);
                 } catch (error) {
                     console.error("Password update error:", error);
                     errorMsg.textContent = "Error updating password. You may need to sign in again.";
                 }
            });
        };
    </script>
</body>
</html>

